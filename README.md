# ❤️ FindMeBot - чат-бот VK для поиска второй половинки

<img src="./Demo/1-Intro/1.gif" width="100%">

## 1. Лимиты внешних API и прочие ограничения

- **Жёсткие лимиты VK API**: сервис работает в рамках установленных ВКонтакте ограничений - количество запросов в секунду и общее суточное количество запросов строго лимитированы. Кроме того, доступность данных (таких как дата рождения, город, фотографии) напрямую зависит от настроек приватности каждого пользователя ВК, поэтому часть информации может быть недоступна

- **Зависимость от внешних изменений**: работоспособность приложения зависит от интерфейса социальной сети ВКонтакте и её API. Любые изменения, внесенные на стороне ВК, могут привести к необходимости соответствующих доработок и корректировок в коде проекта

- **Временные токены доступа**: для выполнения поиска и получения фотографий требуется access-токен пользователя, срок жизни которого ограничен (как правило, несколькими часами). Это создаёт необходимость его периодического ручного обновления для непрерывной работы приложения.

- **Синхронная архитектура обработки запросов**: в текущей реализации бот обрабатывает все входящие запросы синхронно, в рамках одного потока. Это означает, что выполнение ресурсоёмких операций (например, поиска людей или загрузки фотографий) для одного пользователя может замедлить обработку запросов для всех остальных юзеров приложения

## 2. Особенности работы приложения

### 2.1. Регистрация

- Процесс регистрации нового пользователя состоит из следующих последовательных шагов:
  - Нажмите кнопку ```Начать``` на стартовом экране
  - Подтвердите начало процесса регистрации
  - Заполните необходимые данные о себе в анкете и сохраните их
  - На следующем шаге укажите параметры для поиска партнера и сохраните критерии поиска

После успешного завершения регистрации приложение откроет главное меню

<img src="./Demo/2-Functionality/1.gif" width="100%">

### 2.2. Поиск партнера

- Для поиска партнера выполните следующие действия:
  - В главном меню нажмите кнопку ```Поиск```. Приложение отобразит первого подобранного кандидата
  - Для перехода к следующей анкете используйте кнопку ```Вперед```
  - Чтобы вернуться к предыдущей анкете, нажмите кнопку ```Назад```

<img src="./Demo/2-Functionality/2-1.gif" width="100%">

- С каждой анкетой можно выполнить следующие действия:
  - Добавить кандидата в избранное, нажав кнопку ```Добавить в избранное```
  - Добавить кандидата в черный список, нажав кнопку ```Добавить в черный список```

В любой момент можно вернуться в главное меню, нажав кнопку ```Главное меню```

<img src="./Demo/2-Functionality/2-2.gif" width="100%">

### 2.3. Настройка критериев поиска

- Чтобы изменить параметры для подбора партнеров:
  - В главном меню перейдите по кнопке ```Критерии поиска```
  - Внесите необходимые изменения в настройки фильтров и сохраните их

Обновленные критерии будут сразу же применены при последующем поиске.

<img src="./Demo/2-Functionality/3.gif" width="100%">

### 2.4. Избранные

- В этом разделе собраны все кандидаты, добавленные в избранное.
  - Для просмотра списка нажмите кнопку ```Избранные``` в главном меню
  - При желании пользователя можно убрать из списка избранных кандидатов

<img src="./Demo/2-Functionality/4.gif" width="100%">

### 2.5. Черный список

- В данном разделе отображаются пользователи, добавленные в черный список.
  - Для просмотра списка нажмите кнопку ```Черный список``` в главном меню.
  - При желании пользователя можно убрать из черного списка.

<img src="./Demo/2-Functionality/5.gif" width="100%">

## 3. Инструкция по получению токенов ВК

- Дата составления инструкции - ```31.08.2025```. В будущем интерфейс ВК может измениться

### 3.1. Получение токена сообщества ВК

#### 3.1.1. Создание сообщества ВК

- Раздел "Сообщества" → Кнопка "Создать сообщество". Создаем сообщество со следующими параметрами:

```
Цель: Делиться контентом и общаться
Название сообщества: FindMeApp
Приватность сообщества: Открытое
Тематика: Общество
```

<img src="./Demo/3-Tokens/1.png" width="100%">

#### 3.1.2. Включение возможностей бота

- Созданное сообщество ВК → Раздел ```Управление``` → Подраздел ```Сообщения``` → ```Настройки для бота```. Включаем возможности бота и сохраняем изменения.

<img src="./Demo/3-Tokens/2-1.png" width="100%">

<img src="./Demo/3-Tokens/2-2.png" width="100%">

#### 3.1.3. Включение настроек для чат-бота ВК

- Созданное сообщество ВК → Раздел ```Управление``` → Подраздел ```Дополнительно``` → ```Работа с API```. Создаем ключ доступа с установкой необходимых прав.
- Созданный ключ - значение переменной окружения ```VK_GROUP_TOKEN```. Копируем его.

```
# VK_GROUP_TOKEN - токен сообщества ВК
vk1.a.i-xX...xg
```

<img src="./Demo/3-Tokens/3-1.png" width="100%">

<img src="./Demo/3-Tokens/3-2.png" width="100%">

#### 3.1.4. Настройка Long Poll API

- Созданное сообщество ВК → Раздел ```Управление``` → Подраздел ```Дополнительно``` → ```Работа с API``` → Вкладка ```Long Poll API```. Включаем Long Poll API, ставим версию 5.131 и устанавливаем типы сообщений для Long Poll API.

<img src="./Demo/3-Tokens/4-1.png" width="100%">

<img src="./Demo/3-Tokens/4-2.png" width="100%">

<img src="./Demo/3-Tokens/4-3.png" width="100%">

- Версия Long Poll API задается в переменной окружения ```API_LONG_POLL_VERSION```

```
# API_LONG_POLL_VERSION - версия Long Poll API
API_LONG_POLL_VERSION = 5.131
```

### 3.2. Получение токена пользователя ВК

#### 3.2.1. Вход в приложение и разрешение прав

- Сайт [https://vkhost.github.io/](https://vkhost.github.io/) → Приложение ```VK Admin```. После выбора приложения соглашаемся со всеми разрешениями (кнопка ```Разрешить```)
- При желании вместо ```VK Admin``` можно использовать собственное приложение для получения токена: [https://id.vk.com/about/business/go/docs/ru/vkid/latest/vk-id/connection/tokens/access-token](https://id.vk.com/about/business/go/docs/ru/vkid/latest/vk-id/connection/tokens/access-token)

<img src="./Demo/3-Tokens/5-1.png" width="100%">

<img src="./Demo/3-Tokens/5-2.png" width="100%">

#### 3.2.2. Копируем токен пользователя ВК

* Копируем часть адресной строки от ```access_token=``` до ```&expires_in```
* Созданный ключ - значение переменной окружения ```VK_USER_TOKEN```. Копируем его.

```
# VK_USER_TOKEN - токен пользователя ВК
vk1.a.kr...dQ
```

<img src="./Demo/3-Tokens/5-3.png" width="100%">

## 4. Инструкция по локальному запуску проекта

### 4.1. Клонирование репозитория

- Клонирование репозитория:

```bash
git clone https://github.com/maxter9595/FindMeBot.git
cd FindMeBot
```

<img src="./Demo/4-Local-Setup/1.gif" width="100%">

### 4.2. Настройка переменных окружения

* Копирование содержимого ```env_example``` в ```env```:

```bash
bash -c "cp .env_example .env"
```

<img src="./Demo/4-Local-Setup/2-1.gif" width="100%">

* Задание токена для переменной окружения ```VK_GROUP_TOKEN```:

```bash
# vk1.a.i-xX...xg - токен сообщества ВК
bash -c "sed -i 's/VK_GROUP_TOKEN=your_group_token/VK_GROUP_TOKEN=vk1.a.i-xX...xg/' .env"
```

<img src="./Demo/4-Local-Setup/2-2.png" width="100%">

* Задание токена для переменной окружения ```VK_USER_TOKEN```:

```bash
# vk1.a.kr...dQ - токен пользователя ВК
bash -c "sed -i 's/VK_USER_TOKEN=your_user_token/VK_USER_TOKEN=vk1.a.kr...dQ/' .env"
```

<img src="./Demo/4-Local-Setup/2-3.png" width="100%">

### 4.3. Запуск Docker

* Запуск Docker Desktop. Его наличие необходимо для запуска Docker-контейнеров

* Сборка и запуск Docker:

```bash
docker compose build 
docker compose up -d
```

<img src="./Demo/4-Local-Setup/3.gif" width="100%">

### 4.4. Тестирование приложения

* Проверка наличия Docker-контейнеров и запуск тестирования функционала приложения:

```bash
docker-compose ps
docker-compose run test
```

<img src="./Demo/4-Local-Setup/4.gif" width="100%">

### 4.5. Подключение к административной панели СУБД PostgreSQL

* Ссылка для подключения: [http://localhost:5050/](http://localhost:5050/)

* Данные администратора БД для входа в административную панель PostgreSQL:

```
Почта: admin@findme.com
Пароль: Admin123!
```

* `Register...` ➝ `Server...`. Данные соединения:

```
Host: db
Port: 5432
Maintenance database: findme_db
Username: postgres
Password: postgres
```

<img src="./Demo/4-Local-Setup/5.gif" width="100%">

### 4.6. Проверка работы приложения

* Главная страница сообщества ➝ ```Сообщение``` ➝ ```Перейти к диалогу с сообществом```. Разрешаем отправку сообщений (если потребуется) и проверяем работу бота, нажав на кнопку ```Начать```

<img src="./Demo/4-Local-Setup/6.gif" width="100%">

## 5. Инструкция по деплою проекта на сервере

### 5.1. Покупка сервера и подключение к нему

* Рег.RU - Облачный сервер с предустановленным Docker: [https://www.reg.ru/cloud/docker](https://www.reg.ru/cloud/docker)

* Пример IP-адреса и информация о сервере для покупки:

```
- IP-адрес: 95.163.223.69
- Предустановленный Docker: да 
- Образ: Ubuntu
- Тарифы и конфигурации: производительный
- Тариф: HP C2-M2-D40
- Регион размещения: Москва
- Плавающий (публичный) IP-адрес: да
- Резервное копирование: да
```

* Вход на сервер после его приобретения:

```bash
ssh root@95.163.223.69
```

<img src="./Demo/5-Server-Deploy/1.gif" width="100%">

### 5.2. Подготовка сервера для деплоя

* Создание пользователя и добавление его в группу sudo:

```bash
adduser myappuser && usermod -aG sudo myappuser
```

* Установка зависимостей:

```bash
apt update && apt upgrade -y && apt install -y git nginx ufw
```

* Настройка firewall:

```bash
sudo ufw allow 5432 && sudo ufw allow 5050 && sudo ufw allow 22 && ufw allow 80 && sudo ufw --force enable
```

* Запуск Docker, добавление пользователя в группу docker и его переподключение на сервер для утверждения прав:

```bash
# На выбранном сервере Docker уже предустановлен
systemctl enable docker && systemctl start docker && usermod -aG docker myappuser && exit
```

```bash
# Вход по паролю, заданному пользователю через adduser myappuser
ssh myappuser@95.163.223.69
```

<img src="./Demo/5-Server-Deploy/2.gif" width="100%">

### 5.3. Клонирование репозитория. Подготовка переменных окружения

* Клонирование репозитория:

```bash
git clone https://github.com/maxter9595/FindMeBot.git && cd FindMeBot
```

* Копирование содержимого ```env_example``` в ```env```:

```bash
cp .env_example .env
```

<img src="./Demo/5-Server-Deploy/3-1.gif" width="100%">

* Задание токена для переменной окружения ```VK_GROUP_TOKEN```:

```bash
# vk1.a.i-xX...xg - токен сообщества ВК
sed -i 's/VK_GROUP_TOKEN=your_group_token/VK_GROUP_TOKEN=vk1.a.i-xX...xg/' .env
```

<img src="./Demo/5-Server-Deploy/3-2.png" width="100%">

* Задание токена для переменной окружения ```VK_GROUP_TOKEN```:

```bash
# vk1.a.kr...dQ - токен пользователя ВК
sed -i 's/VK_USER_TOKEN=your_user_token/VK_USER_TOKEN=vk1.a.kr...dQ/' .env
```

<img src="./Demo/5-Server-Deploy/3-3.png" width="100%">

### 5.4. Запуск Docker и тестирование функционала

* Сборка и запуск Docker, тестирование функционала:

```bash
docker compose build && docker compose up -d && docker compose run test
```

<img src="./Demo/5-Server-Deploy/4.gif" width="100%">

### 5.5. Настройка админской панели СУБД PostgreSQL

* Админка PostgreSQL (через PGAdmin): [http://95.163.223.69:5050/](http://95.163.223.69:5050/)

* Данные администратора БД для входа в административную панель СУБД PostgreSQL:

```
Почта: admin@findme.com
Пароль: Admin123!
```

* `Register...` ➝ `Server...`. Данные соединения к БД в СУБД PostgreSQL:

```
Host: db
Port: 5432
Maintenance database: findme_db
Username: postgres
Password: postgres
```

<img src="./Demo/5-Server-Deploy/5.gif" width="100%">

### 5.6. Проверка работы приложения

* Главная страница сообщества ➝ ```Сообщение``` ➝ ```Перейти к диалогу с сообществом```. Разрешаем отправку сообщений (если потребуется) и проверяем работу бота, нажав на кнопку ```Начать```

<img src="./Demo/4-Local-Setup/6.gif" width="100%">

## 6. Настройка автодеплоя проекта (CI/CD)

### 6.1. Генерация SSH-ключа на локальном ПК

* Генерация SSH-ключа на локальном ПК:

```bash
ssh-keygen -t ed25519 -C "max.t95@bk.ru"
```

* Вывод SSH-ключа из локального ПК для копирования:

```bash
type $env:USERPROFILE\.ssh\id_ed25519.pub
```

```bash
# Копируем SSH-ключ
ssh-ed25519 AAAA...Sk max.t95@bk.ru
```

<img src="./Demo/6-CI-CD/1.png" width="100%">

### 6.2. Генерация SSH-ключа на сервере

* Вход на сервер:

```bash
ssh myappuser@95.163.223.69
```

* Генерация SSH-ключа на сервере:

```bash
ssh-keygen -t ed25519 -C "max.t95@bk.ru"
```

* Вывод SSH-ключа из сервера для просмотра:

```bash
ssh-keygen -y -f ~/.ssh/id_ed25519
```

```bash
# SSH-ключ из сервера понадобится для удаленного подключения к GitHub
ssh-ed25519 AAAA...TT max.t95@bk.ru
```

<img src="./Demo/6-CI-CD/2.png" width="100%">

### 6.3. Добавление SSH-ключей из локального ПК и сервера в список авторизованных ключей сервера

* Ввод SSH-ключа из сервера в список авторизированных ключей:

```bash
ssh-keygen -y -f ~/.ssh/id_ed25519 >> ~/.ssh/authorized_keys
```

* Ввод SSH-ключа из локального ПК в список авторизированных ключей:

```bash
echo "ssh-ed25519 AAAA...Sk max.t95@bk.ru" >> ~/.ssh/authorized_keys
```

* Просмотр списка авторизированных ключей:

```bash
cat ~/.ssh/authorized_keys
```

```bash
# В результате должно быть два SSH-ключа в списке авторизованных ключей
ssh-ed25519 AAAA...TT max.t95@bk.ru
ssh-ed25519 AAAA...Sk max.t95@bk.ru
```

<img src="./Demo/6-CI-CD/3.png" width="100%">

### 6.4. Настройка sudo без пароля для CI/CD

* Настройка прав для authorized_keys:

```bash
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

* Вход в visudo и добавление параметров для обхода паролей пользователя при деплое:  

```bash
sudo visudo
```

```bash
# Добавляем в конце файла следующее:
myappuser ALL=(ALL) NOPASSWD: ALL
```

* Выход из сервера и проверка входа на сервер без пароля:

```bash
exit
ssh myappuser@95.163.223.69
# Если всё ок — войдём без пароля
```

<img src="./Demo/6-CI-CD/4.gif" width="100%">

### 6.5. Привязка SSH-ключа к GitHub

* Вывод публичного SSH-ключа для интеграции с GitHub:

```bash
cat ~/.ssh/id_ed25519.pub
```

```bash
# Копируем все, что будет выведено
ssh-ed25519 AAAA...TT max.t95@bk.ru
```

* Привязка публичного ключа к GitHub:

   * ```Сайт GitHub``` → ```Settings``` → ```SSH and GPG keys``` → ```New SSH key```. Заполняем параметры SHH-ключа:

     * Тип ключа: ```Authentication Key``` 
  
     * Имя ключа: ```VM-server```

     * В поле ```Key``` добавляем содержимое SSH-ключа. Пример - ```ssh-ed25519 AAAA...TT max.t95@bk.ru```

  * После добавления параметров SSH-ключа нажимаем ```Add SSH key```

<img src="./Demo/6-CI-CD/5.png" width="100%">

### 6.6.Настройка файла SSH-конфигурации. Проверка подключения к GitHub

* Внесение GitHub в список известных хостов сервера:

```bash
ssh-keyscan -H github.com >> ~/.ssh/known_hosts
```

* Настройка конфигурации для SSH:

```bash
nano ~/.ssh/config
```

```
----- ~/.ssh/config -----
Host github.com
    HostName github.com
    User git
    IdentityFile ~/.ssh/id_ed25519
----- ~/.ssh/config -----
```

* Установка прав для файла SSH-конфигурации:

```bash
chmod 600 ~/.ssh/config
```

* Проверка взаимодействия с GitHub:

```bash
ssh -T git@github.com
# Если всё ок — увидим следующее сообщение:
# Hi <логин>! You've successfully authenticated ...
```

<img src="./Demo/6-CI-CD/6.gif" width="100%">

### 6.7. Установка значений secret-параметров GitHub-репозитория для автодеплоя

* Ввод команды на сервере для получения ```SSH_PRIVATE_KEY```:

```bash
cat ~/.ssh/id_ed25519
```

```bash
# Копируем все вместе с комментариями BEGIN и END
-----BEGIN OPENSSH PRIVATE KEY----- 
b3...= 
-----END OPENSSH PRIVATE KEY-----
```

* Ввод secrets для автодеплоя GitHub-репозитория:

  * SSH_HOST: ```95.163.223.69``` (или другой IP-адрес сервера)

  * SSH_USER: ```myappuser```

  * SSH_PRIVATE_KEY: результат команды ```cat ~/.ssh/id_ed25519``` на сервере

  * VK_GROUP_TOKEN: токен сообщества ВК

  * VK_USER_TOKEN: токен пользователя ВК

<img src="./Demo/6-CI-CD/7-1.png" width="100%">

* После установки secrets проверяем функционал автодеплоя

<img src="./Demo/6-CI-CD/7-2.gif" width="100%">
